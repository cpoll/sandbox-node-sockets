<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Socket.IO chat</title>
    <style>
        .hidden {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />
</head>

<body>
    <main class="container">
        <div id="roomId"></div>
        <div id="users"></div>

        <!-- Join Menu -->
        <div class="modal container" id="joinMenu">
            <section class="grid">
                <button class="outline" onClick="createRoom();">Create Room</button>
            </section>
            <section class="grid">
                <input id="joinId"></input>
                <button class="outline secondary" onClick="joinRoom();">Join Room</button>
            </section>
            <section>
                <button onClick="sendMessage();">Send Message Over Socket</button>
            </section>
        </div>

        <!-- Area Picker -->
        <div class="modal container" id="pickArea">
            Address: <input id="pickerAddress"></input><button onClick="pickAddress();">Go</button>
        </div>


        <div class="modal container" id="vote"></div>
        <div class="modal container" id="results"></div>

        <dialog id="message-modal">
            <article>
                <header>
                    <button aria-label="Close" rel="prev" data-target="modal-example"
                        onclick="closeMessageModal()"></button>
                    <h3></h3>
                </header>
                <p></p>
                <footer>
                    <button role="button" class="primary" data-target="modal-example"
                        onclick="closeMessageModal()">Ok</button>
                </footer>
            </article>
        </dialog>
    </main>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    const joinMenu = document.getElementById('joinMenu');
    const pickArea = document.getElementById('pickArea');
    const vote = document.getElementById('vote');
    const results = document.getElementById('results');

    const modals = [joinMenu, pickArea, vote, results];
    modals.forEach(m => m.classList.add('hidden'));
    joinMenu.classList.remove('hidden');

    let roomId;

    // No server url parameter required; defaults to connecting to the host serving this page
    const socket = io({
        auth: {
            serverOffset: 0,
        },
        ackTimeout: 5000,
        retries: 3, // TODO: Test and add loading bar; can add a "disconnect" testing button for this
    });

    // Helpers
    const setRoomId = (roomIdFromServer) => {
        roomId = roomIdFromServer;
        document.getElementById('roomId').innerHTML = `Room ID: ${roomId}`;
    }

    // Buttons
    const createRoom = () => {
        modals.forEach(m => m.classList.add('hidden'));
        pickArea.classList.remove('hidden');
    }

    const pickAddress = () => {
        modals.forEach(m => m.classList.add('hidden'));
        vote.classList.remove('hidden');

        const address = document.getElementById('pickerAddress').value;

        socket.emit('clientEvent', { type: 'startRoom', address: address }, (_err, response) => {
            setRoomId(response.roomId);
        })
    }

    const joinRoom = () => {
        const roomId = document.getElementById('joinId').value;
        socket.emit(
            'clientEvent',
            { type: 'joinRoom', roomId: roomId },
            (_err, response) => {
                if (response.error) {
                    openMessageModal('Join Room', `Room does not exist`);
                    return;
                };

                setRoomId(response.roomId);

                modals.forEach(m => m.classList.add('hidden'));
                vote.classList.remove('hidden');

            });
    }



    const sendMessage = () => {
        socket.emit('clientEvent', { type: 'hello', message: 'Hello, world!' });
    }

    // Server Events
    socket.on('serverEvent', (event) => {
        // TODO: Sending events to _everyone_ is hilariously bad
        if (event.roomId !== roomId) { return; }

        switch (event.type) {
            case "userJoined":
                document.getElementById('users').innerHTML = event.users;
                break;
            case "results":
                modals.forEach(m => m.classList.add('hidden'));
                results.classList.remove('hidden');
            default:
                console.error('invalid server event', event);
                break;
        }

        console.log('Received server event:', event);
    });


    const closeMessageModal = () => {
        document.getElementById('message-modal')?.removeAttribute('open');
    };

    const openMessageModal = (header, message) => {
        document.getElementById('message-modal').querySelector('h3').textContent = header;
        document.getElementById('message-modal').querySelector('p').textContent = message;
        document.getElementById('message-modal').setAttribute('open', '');
    };

    // const form = document.getElementById("form");
    // const input = document.getElementById("input");
    // const messages = document.getElementById("messages");

    // form.addEventListener('submit', (e) => {
    //     e.preventDefault();
    //     if (input.value) {
    //         const clientOffset = `${socket.id}-${counter++}`;
    //         socket.emit('chat message', input.value, clientOffset);
    //         input.value = '';
    //     }
    // });

    // Received a message from the server
    // socket.on('chat message', (msg, serverOffset) => {
    //     // TODO: Not clear if this is possible.
    //     if (serverOffset > socket.auth.serverOffset + 1) {
    //         alert(`Server offset is too far ahead! Server: ${serverOffset}, Client: ${socket.auth.serverOffset}`);
    //         throw new Error(`Client offset is too far behind! Server: ${serverOffset}, Client: ${socket.auth.serverOffset}`);
    //     }

    //     const item = document.createElement('li');
    //     item.textContent = msg;
    //     messages.appendChild(item);
    //     window.scrollTo(0, document.body.scrollHeight);

    //     socket.auth.serverOffset = serverOffset;
    // });

</script>

</html>